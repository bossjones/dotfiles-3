#!/bin/bash

libvbox-kill() {
    VBoxManage controlvm "$1" poweroff
}

libvbox-list() {
    IFS=$'\n'
    list="$( VBoxManage list "$1" | egrep '^\"' | awk -F' {' '{ print $1 }' )"
    for name in $list; do
        t=${name#\"}
        echo ${t%\"}
    done
}

libvbox-start() {
    if [[ -n "$2" ]]; then
        TYPE="$2"
    else
        TYPE="headless"
    fi
    if [[ -n "$1" ]]; then
        VBoxManage startvm "$1" --type "$TYPE" &>/dev/null || libvbox-error "Unable to start VM."
    else
        libvbox-error "VM name required."
    fi
}

libvbox-stop() {
    if [[ -n "$1" ]]; then
        VBoxManage controlvm "$1" acpipowerbutton &>/dev/null || libvbox-error "Unable to stop VM."
    else
        libvbox-error "VM name required."
    fi
}

libvbox-error() {
    echo "$1" >&2
    exit 1
}

case "$1" in
    "kill")
        libvbox-kill "$2"
        ;;
    "list")
        libvbox-list "runningvms"
        ;;
    "list-all")
        libvbox-list "vms"
        ;;
    "start")
        libvbox-start "$2" "$3"
        ;;
    "stop")
        libvbox-stop "$2"
        ;;
    *)
        libvbox-error "Command required."
        ;;
esac
