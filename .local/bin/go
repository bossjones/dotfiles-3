#!/usr/bin/env python

import os
import glob
import optparse
import ops.utils

BUILD = '/home/silas/src/go/bin/6g'
LINK = '/home/silas/src/go/bin/6l'

def build(src):
    result = ops.utils.run('${prog} ${src}', prog=BUILD, src=src)
    if not result:
        ops.utils.exit(1, result.stdout)

def link(src, dst):
    result = ops.utils.run('${prog} ${src} -o ${dst}', prog=LINK, src=src, dst=dst)
    if not result:
        ops.utils.exit(1, result.stdout)

def main():
    parser = optparse.OptionParser()
    parser.add_option(
        '-o',
        dest='name',
        default='program',
        help='program output name',
        metavar='NAME',
    )
    options, args = parser.parse_args()

    path = os.getcwd()

    build_src = [os.path.join(path, name) for name in glob.glob('*.go')]
    build(build_src)

    link_src = [os.path.join(path, name) for name in glob.glob('*.6')]
    link(link_src, options.name)

if __name__ == '__main__':
    main()
